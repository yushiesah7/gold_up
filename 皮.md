# ──────────────────────────────────────────────────────────────────────────────
# Tests — Minimal Suite (pytest)
# 目的: にうむさんのポリシーに沿った最小テスト群（Domain純粋/Infra統合/Adapter単体）。
# 置き場所: プロジェクトルートから `autotrade_poc/tests/` 配下に配置してください。
# 依存: pytest, pydantic, PyYAML（既に導入済み想定）
# 実行: uv run pytest -q
# ──────────────────────────────────────────────────────────────────────────────

# =============================================================================
# file: autotrade_poc/tests/__init__.py
# =============================================================================
# 空ファイル（pytestのパッケージ検出用）


# =============================================================================
# file: autotrade_poc/tests/test_domain_models.py
# =============================================================================
from __future__ import annotations

import pytest
from pydantic import ValidationError

from autotrade_poc.domain.models.market import Symbol, Timeframe
from autotrade_poc.domain.models.risk import RiskPolicy
from autotrade_poc.domain.models.spec import SessionConstraint


def test_symbol_must_not_be_empty() -> None:
    with pytest.raises(ValidationError):
        Symbol(value="")


def test_timeframe_contains_m15() -> None:
    assert Timeframe.M15.value == "M15"


def test_risk_policy_range() -> None:
    # OK
    RiskPolicy(per_trade_risk_pct=0.02)
    # NG: 下限/上限外
    with pytest.raises(ValidationError):
        RiskPolicy(per_trade_risk_pct=0.0)
    with pytest.raises(ValidationError):
        RiskPolicy(per_trade_risk_pct=0.5)


def test_session_constraint_valid_minimal() -> None:
    SessionConstraint(timezone="UTC", start="09:00", end="17:00")


@pytest.mark.xfail(reason="フォーマット検証は未実装（将来の仕様）。文字列なら通る現仕様を明示）", strict=False)
def test_session_constraint_invalid_format_expected_future_validation() -> None:
    # 現状は単なる str 型なので ValidationError は出ない想定（将来の拡張でエラー化予定）
    SessionConstraint(timezone="UTC", start="9am", end="5pm")


# =============================================================================
# file: autotrade_poc/tests/test_yaml_registry_adapter.py
# =============================================================================
from __future__ import annotations

from pathlib import Path

from autotrade_poc.infrastructure.adapters.yaml_registry_adapter import YAMLRegistryAdapter
from autotrade_poc.domain.models.spec import LiveSpec


def test_yaml_registry_loads_single_file(tmp_path: Path) -> None:
    d = tmp_path / "specs"
    d.mkdir()
    (d / "one.yaml").write_text(
        """
market_symbol: {value: "EURUSD"}
market_timeframe: "M15"
ensemble:
  columns: [{label: "rsi=14"}]
  weights: {"rsi=14": 1.0}
  meta: {}
execution:
  order_type: "market"
  price: "nextopen"
  slippage_rate: 0.0001
  fees_rate: 0.0
  size: 0.10
  leverage: 1.0
  init_cash: 100000
stops_mode: "atr_rr"
stops_atr_rr:
  atr_window: [14]
  k_for_sl: [1.0]
  rr: [2.0]
risk:
  per_trade_risk_pct: 0.02
        """,
        encoding="utf-8",
    )
    adapter = YAMLRegistryAdapter(yaml_dir=str(d))
    specs = adapter.load_live_specs()
    assert len(specs) == 1
    spec = specs[0]
    assert isinstance(spec, LiveSpec)
    assert spec.market_symbol.value == "EURUSD"
    assert spec.market_timeframe.value == "M15"


def test_yaml_registry_skips_empty(tmp_path: Path) -> None:
    d = tmp_path / "specs"
    d.mkdir()
    (d / "empty.yaml").write_text("\n", encoding="utf-8")  # 空
    adapter = YAMLRegistryAdapter(yaml_dir=str(d))
    specs = adapter.load_live_specs()
    assert specs == []


# =============================================================================
# file: autotrade_poc/tests/test_system_clock_adapter.py
# =============================================================================
from __future__ import annotations

import time
from datetime import timezone, timedelta

from autotrade_poc.infrastructure.adapters.system_clock_adapter import SystemClockAdapter


def test_now_returns_timezone_aware() -> None:
    clk = SystemClockAdapter()
    now = clk.now()
    assert now.tzinfo is not None
    # UTC想定
    assert now.utcoffset() == timedelta(0)


def test_sleep_until_short_interval() -> None:
    clk = SystemClockAdapter()
    start = time.perf_counter()
    target = clk.now() + timedelta(seconds=0.10)
    clk.sleep_until(target)
    elapsed = time.perf_counter() - start
    assert elapsed >= 0.09
    assert elapsed < 1.0


# =============================================================================
# file: autotrade_poc/tests/test_std_logger_adapter.py
# =============================================================================
from __future__ import annotations

import logging

from autotrade_poc.infrastructure.adapters.std_logger_adapter import StdLoggerAdapter


def test_logger_does_not_duplicate_handlers() -> None:
    l1 = StdLoggerAdapter(name="autotrade_test")
    before = len(logging.getLogger("autotrade_test").handlers)
    l2 = StdLoggerAdapter(name="autotrade_test")  # 再初期化
    after = len(logging.getLogger("autotrade_test").handlers)
    assert after == before  # 2回初期化してもハンドラ数は増えない


# =============================================================================
# （任意）MT5依存テストの雛形 ─ Windows＋MetaTrader5 が用意できるときのみ
# file: autotrade_poc/tests/test_mt5_optional.py
# =============================================================================
from __future__ import annotations

import platform
import pytest

MetaTrader5 = pytest.importorskip("MetaTrader5")  # 未インストールならスキップ

is_windows = platform.system().lower().startswith("win")

pytestmark = pytest.mark.skipif(not is_windows, reason="Windows環境のみ実行")


def test_mt5_module_importable() -> None:
    # 形だけの確認（口座接続テストは別途環境が必要なのでスキップ）
    assert hasattr(MetaTrader5, "initialize")


にうむ、いいね！そのツリーなら**不足テスト一式を“追加入力だけ”で用意**できるよ。右側キャンバスに\*\*「Tests — Minimal Suite (pytest)」\*\*として、以下のファイルを丸ごと置いたから、そのままコピーして `autotrade_poc/tests/` に配置してね（既存コードは触っていないよ）。

## 追加したテスト（要約）

* `test_domain_models.py`：

  * `Symbol` 空文字→`ValidationError`、`Timeframe.M15` 値確認、`RiskPolicy` の範囲、`SessionConstraint` の基本（フォーマット検証は**将来追加前提で xfail**にして明示）
* `test_yaml_registry_adapter.py`：

  * 一時フォルダにYAMLを書いて\*\*`YAMLRegistryAdapter`→`LiveSpec`\*\*取り込み／空YAMLはスキップ
* `test_system_clock_adapter.py`：

  * `SystemClockAdapter.now()` が**UTC aware**、`sleep_until()` が短時間で待機
* `test_std_logger_adapter.py`：

  * **二重初期化でハンドラが増えない**こと（重複ログ防止）
* （任意）`test_mt5_optional.py`：

  * **Windows かつ MetaTrader5 インストール時のみ**走るスモークテスト（環境無ければ自動 skip）

> `tmp_path` の使い方や `skipif/xfail` は pytest 公式の推奨どおりに書いてるよ。`tmp_path` は各テストごとにユニークな一時ディレクトリをくれるフィクスチャ、`skipif/xfail` は条件付きスキップや「期待される失敗」の明示に使うやつ。([docs.pytest.org][1])
> YAMLは**必ず `safe_load`** 系で扱う前提（`load`は非推奨/危険）。([GitHub][2], [pyyaml.org][3])
> ログの**重複ハンドラ**はPython loggingのよくある落とし穴。**同名ロガーに何度もハンドラを足さない**のが基本だよ。([Python documentation][4], [Stack Overflow][5])

---

## 置き場所

```
autotrade_poc/
  tests/
    __init__.py
    test_domain_models.py
    test_yaml_registry_adapter.py
    test_system_clock_adapter.py
    test_std_logger_adapter.py
    test_mt5_optional.py   # 任意
```

## 実行コマンド

```powershell
uv sync --extra dev
uv run pytest -q
```

### 期待値メモ

* `yaml_registry_adapter.py` と `system_clock_adapter.py` が**未実装**のままなら、対応テストは失敗します（意図どおり “足りないもの検知”）。
* `SessionConstraint` のフォーマット検証は**まだ未実装**なので、該当テストは **xfail** で“将来の義務”を固定化しています（CIに入れてもレッドにならない運用）。([docs.pytest.org][6])

---

## “gotcha”クイズ（テスト運用あるある）

1. **Q.** `yaml.load` をテストで使うのは危ないのはなぜ？
   **A.** 任意オブジェクト構築＝RCEリスク。**`safe_load`** を使う。([GitHub][2])
2. **Q.** ロガー2回初期化でログが2重出力…なぜ？
   **A.** **同名ロガー**は同一インスタンス。毎回ハンドラ追加で**重複**する。**一度だけ付与**が基本。([Stack Overflow][5])
3. **Q.** 外部依存（MT5）がないマシンでCIを通したい。どうする？
   **A.** `pytest.mark.skipif` / `importorskip` で**条件付きスキップ**。([docs.pytest.org][7])

---

ログイン処理は**あなた側で用意済み**とのことなので、こちらのテストは**そのまま併用可能**です。もし `system_clock_adapter.py` や `yaml_registry_adapter.py` が未実装でテストが落ちたら、最小実装をあてるパッチもすぐ出せます。どう進めるか、合図くださいね。

[1]: https://docs.pytest.org/en/stable/how-to/tmp_path.html?utm_source=chatgpt.com "How to use temporary directories and files in tests"
[2]: https://github.com/yaml/pyyaml/wiki/PyYAML-yaml.load%28input%29-Deprecation?utm_source=chatgpt.com "PyYAML yaml.load(input) Deprecation"
[3]: https://pyyaml.org/wiki/PyYAMLDocumentation?utm_source=chatgpt.com "PyYAML Documentation"
[4]: https://docs.python.org/3/howto/logging-cookbook.html?utm_source=chatgpt.com "Logging Cookbook — Python 3.13.7 documentation"
[5]: https://stackoverflow.com/questions/7173033/duplicate-log-output-when-using-python-logging-module?utm_source=chatgpt.com "Duplicate log output when using Python logging module"
[6]: https://docs.pytest.org/en/stable/how-to/mark.html?utm_source=chatgpt.com "How to mark test functions with attributes"
[7]: https://docs.pytest.org/en/stable/reference/reference.html?utm_source=chatgpt.com "API Reference"
